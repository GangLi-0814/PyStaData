# 2_数据处理

**创建日期：** 20200805 15:20      
**上次修改：** 20200805 19:27   
**Python版本：** Python 3.7  

项目介绍：一直想写一份适合经济学等社科背景、学术科研向的Python教程。因为学经济学的多少会对Stata有所了解，有一些写~代码~命令的经历，这份教程应该：

- 简洁好理解，花最少的时间了解 Python 的核心用法；
- 实用易操作，最好是能够看完上手即用。

在构思了一段时间之后，偶然发现 Ties de Kok 的 [Get started with Python for research tutorial](https://github.com/TiesdeKok/LearnPythonforResearch)项目已经搭建出了我想要的框架。于是打算在这个项目的基础上进行完善，首先将其主要内容“汉化”成中文，之后对用法进行扩充、加入典型用法和案例。

>原作者简介：Ties de Kok ([Personal Website](http://www.tiesdekok.com))为华盛顿大学福斯特商学院的助理教授，他专注于将计算机科学与实证会计研究相结合，研究兴趣是财务会计、资本市场、计算机科学、自然语言处理和经验管理会计。

本部分基于 PyCon 2015 tutorial/talk by Brandon Rhodes，如果想了解更多，建议观看：

https://www.youtube.com/watch?v=5JnMutdy6Fw  
https://github.com/brandon-rhodes/pycon-pandas-tutorial

往期目录：

[PythonforResearch | 0_语法基础](https://mp.weixin.qq.com/s/rA5kgJvA8eQHRjx9pUGoXA)

[PythonforResearch | 1_文件操作](https://mp.weixin.qq.com/s/f9q7vVG5iT7w9HQTfQmIHw)

# 导入 Pandas 库


```python
import pandas as pd
import numpy as np
```


```python
import os
from os.path import join
```


```python
# 定义路径
data_path = join(os.getcwd(), 'data')
```

# 创建 dataframe

## 导入本地数据


```python
df_auto = pd.read_csv(join(data_path, 'auto_df.csv'), sep=';', index_col='Unnamed: 0')
```

## 创建并传入数据

可以传入多种类型的数据到 `pd.DataFrame()`：


```python
d = {'col1': [1,2,3,4], 'col2': [5,6,7,8]}
df = pd.DataFrame(data=d)
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>col1</th>
      <th>col2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>7</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>8</td>
    </tr>
  </tbody>
</table>
</div>




```python
d = [(1, 2 ,3 ,4), (5, 6, 7, 8)]
df = pd.DataFrame(data=d)
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
  </tbody>
</table>
</div>



## 由字典创建


```python
d = {'row1': [1,2,3,4], 'row2': [5,6,7,8]}
df = pd.DataFrame.from_dict(d, orient='index')
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
  </tbody>
</table>
</div>



也可以直接传入字典：


```python
df = pd.DataFrame.from_dict({'row1': [1,2,3,4], 'row2': [5,6,7,8]}, orient='index')
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
  </tbody>
</table>
</div>



# 操作 dataframe

## 添加列（Add columns）


```python
df['col5'] = [10, 10]
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>col5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>10</td>
    </tr>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>



## 添加行（Add row）


```python
df.loc['row3'] = [11, 12, 13, 14, 15]
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>col5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>10</td>
    </tr>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div>



## 转置（Inverse dataframe）


```python
df.T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>row1</th>
      <th>row2</th>
      <th>row3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>11</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>6</td>
      <td>12</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>7</td>
      <td>13</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>8</td>
      <td>14</td>
    </tr>
    <tr>
      <th>col5</th>
      <td>10</td>
      <td>10</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div>



## 删除列（Remove columns）


```python
df = df.drop('col5', axis=1) # axis =1 : column
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row1</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



## 删除行（Remove row）


```python
df = df.drop('row1', axis=0)
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



## 设置索引（Set index）


```python
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.set_index(0)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
    <tr>
      <th>0</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



提示：Pandas允许多索引，这在数据分析中非常实用。


```python
df.set_index(0, append=True)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
    <tr>
      <th></th>
      <th>0</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row2</th>
      <th>5</th>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <th>11</th>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



## 重置索引（Reset index）

使用`reset_index()`将索引（index）转化为常规的列（regular column）。


```python
df.reset_index()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>row2</td>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>row3</td>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



# 重命名列（Rename columns）

可以直接操作`df.columns`或使用`df.rename()`：


```python
df.columns = ['col1','col2','col3','col4']
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>col1</th>
      <th>col2</th>
      <th>col3</th>
      <th>col4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.rename(columns={'col1' : 'column1', 'col2' : 'column2'})
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>column1</th>
      <th>column2</th>
      <th>col3</th>
      <th>col4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>row2</th>
      <td>5</td>
      <td>6</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>row3</th>
      <td>11</td>
      <td>12</td>
      <td>13</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>



使用`df.rename()`是复制后修改，不会对原来的df覆盖。要对原来的df进行覆盖，需要使用`inplace=True`选项。


```python
df = df.rename(columns={'col1' : 'column1', 'col2' : 'column2'})
#or
df.rename(columns={'col1' : 'column1', 'col2' : 'column2'}, inplace=True) 
```

# 预览 dataframe

## 全部


```python
df_auto # 只显示首部和尾部
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AMC Concord</td>
      <td>4099</td>
      <td>22</td>
      <td>3.0</td>
      <td>2.5</td>
      <td>11</td>
      <td>2930</td>
      <td>186</td>
      <td>40</td>
      <td>121</td>
      <td>3.58</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AMC Pacer</td>
      <td>4749</td>
      <td>17</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>11</td>
      <td>3350</td>
      <td>173</td>
      <td>40</td>
      <td>258</td>
      <td>2.53</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AMC Spirit</td>
      <td>3799</td>
      <td>22</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>12</td>
      <td>2640</td>
      <td>168</td>
      <td>35</td>
      <td>121</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Buick Century</td>
      <td>4816</td>
      <td>20</td>
      <td>3.0</td>
      <td>4.5</td>
      <td>16</td>
      <td>3250</td>
      <td>196</td>
      <td>40</td>
      <td>196</td>
      <td>2.93</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Buick Electra</td>
      <td>7827</td>
      <td>15</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>20</td>
      <td>4080</td>
      <td>222</td>
      <td>43</td>
      <td>350</td>
      <td>2.41</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>69</th>
      <td>VW Dasher</td>
      <td>7140</td>
      <td>23</td>
      <td>4.0</td>
      <td>2.5</td>
      <td>12</td>
      <td>2160</td>
      <td>172</td>
      <td>36</td>
      <td>97</td>
      <td>3.74</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>70</th>
      <td>VW Diesel</td>
      <td>5397</td>
      <td>41</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>15</td>
      <td>2040</td>
      <td>155</td>
      <td>35</td>
      <td>90</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>71</th>
      <td>VW Rabbit</td>
      <td>4697</td>
      <td>25</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>15</td>
      <td>1930</td>
      <td>155</td>
      <td>35</td>
      <td>89</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>72</th>
      <td>VW Scirocco</td>
      <td>6850</td>
      <td>25</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>16</td>
      <td>1990</td>
      <td>156</td>
      <td>36</td>
      <td>97</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>73</th>
      <td>Volvo 260</td>
      <td>11995</td>
      <td>17</td>
      <td>5.0</td>
      <td>2.5</td>
      <td>14</td>
      <td>3170</td>
      <td>193</td>
      <td>37</td>
      <td>163</td>
      <td>2.98</td>
      <td>Foreign</td>
    </tr>
  </tbody>
</table>
<p>74 rows × 12 columns</p>
</div>



## 首部和尾部


```python
df_auto.head(3) # 首部3条数据
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AMC Concord</td>
      <td>4099</td>
      <td>22</td>
      <td>3.0</td>
      <td>2.5</td>
      <td>11</td>
      <td>2930</td>
      <td>186</td>
      <td>40</td>
      <td>121</td>
      <td>3.58</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AMC Pacer</td>
      <td>4749</td>
      <td>17</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>11</td>
      <td>3350</td>
      <td>173</td>
      <td>40</td>
      <td>258</td>
      <td>2.53</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AMC Spirit</td>
      <td>3799</td>
      <td>22</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>12</td>
      <td>2640</td>
      <td>168</td>
      <td>35</td>
      <td>121</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_auto.tail(5) # 尾部5条数据
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>69</th>
      <td>VW Dasher</td>
      <td>7140</td>
      <td>23</td>
      <td>4.0</td>
      <td>2.5</td>
      <td>12</td>
      <td>2160</td>
      <td>172</td>
      <td>36</td>
      <td>97</td>
      <td>3.74</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>70</th>
      <td>VW Diesel</td>
      <td>5397</td>
      <td>41</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>15</td>
      <td>2040</td>
      <td>155</td>
      <td>35</td>
      <td>90</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>71</th>
      <td>VW Rabbit</td>
      <td>4697</td>
      <td>25</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>15</td>
      <td>1930</td>
      <td>155</td>
      <td>35</td>
      <td>89</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>72</th>
      <td>VW Scirocco</td>
      <td>6850</td>
      <td>25</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>16</td>
      <td>1990</td>
      <td>156</td>
      <td>36</td>
      <td>97</td>
      <td>3.78</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>73</th>
      <td>Volvo 260</td>
      <td>11995</td>
      <td>17</td>
      <td>5.0</td>
      <td>2.5</td>
      <td>14</td>
      <td>3170</td>
      <td>193</td>
      <td>37</td>
      <td>163</td>
      <td>2.98</td>
      <td>Foreign</td>
    </tr>
  </tbody>
</table>
</div>



## 随机X部分


```python
X = 5
df_auto.sample(X)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>13</th>
      <td>Chev. Chevette</td>
      <td>3299</td>
      <td>29</td>
      <td>3.0</td>
      <td>2.5</td>
      <td>9</td>
      <td>2110</td>
      <td>163</td>
      <td>34</td>
      <td>231</td>
      <td>2.93</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Chev. Nova</td>
      <td>3955</td>
      <td>19</td>
      <td>3.0</td>
      <td>3.5</td>
      <td>13</td>
      <td>3430</td>
      <td>197</td>
      <td>43</td>
      <td>250</td>
      <td>2.56</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389</td>
      <td>28</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9</td>
      <td>1800</td>
      <td>147</td>
      <td>33</td>
      <td>98</td>
      <td>3.15</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AMC Spirit</td>
      <td>3799</td>
      <td>22</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>12</td>
      <td>2640</td>
      <td>168</td>
      <td>35</td>
      <td>121</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Buick Electra</td>
      <td>7827</td>
      <td>15</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>20</td>
      <td>4080</td>
      <td>222</td>
      <td>43</td>
      <td>350</td>
      <td>2.41</td>
      <td>Domestic</td>
    </tr>
  </tbody>
</table>
</div>



## 通过行名选取行

**注意：**下面返回的是Pandas的 Series 对象，这与Pandas的 Dataframe 对象不同！


```python
df_auto['make'].head(3)
```




    0    AMC Concord
    1      AMC Pacer
    2     AMC Spirit
    Name: make, dtype: object



如果列名没有空格，则还可以在列名后使用点号(`.`)：


```python
df_auto.make.head(3)
```




    0    AMC Concord
    1      AMC Pacer
    2     AMC Spirit
    Name: make, dtype: object



使用双引号，选择多列：


```python
df_auto[['make', 'price', 'mpg']].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AMC Concord</td>
      <td>4099</td>
      <td>22</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AMC Pacer</td>
      <td>4749</td>
      <td>17</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AMC Spirit</td>
      <td>3799</td>
      <td>22</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Buick Century</td>
      <td>4816</td>
      <td>20</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Buick Electra</td>
      <td>7827</td>
      <td>15</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Buick LeSabre</td>
      <td>5788</td>
      <td>18</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Buick Opel</td>
      <td>4453</td>
      <td>26</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Buick Regal</td>
      <td>5189</td>
      <td>20</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Buick Riviera</td>
      <td>10372</td>
      <td>16</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Buick Skylark</td>
      <td>4082</td>
      <td>19</td>
    </tr>
  </tbody>
</table>
</div>



## 通过索引值选取行


```python
df = df_auto[['make', 'price', 'mpg', 'trunk', 'headroom']].set_index('make')
```


```python
df.loc['Buick Riviera']
```




    price       10372.0
    mpg            16.0
    trunk          17.0
    headroom        3.5
    Name: Buick Riviera, dtype: float64



注意：返回一个pandas.Series对象而不是pandas.Dataframe对象。

## 通过索引位置选取行


```python
df.iloc[2:5] # index location
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>trunk</th>
      <th>headroom</th>
    </tr>
    <tr>
      <th>make</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AMC Spirit</th>
      <td>3799</td>
      <td>22</td>
      <td>12</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>Buick Century</th>
      <td>4816</td>
      <td>20</td>
      <td>16</td>
      <td>4.5</td>
    </tr>
    <tr>
      <th>Buick Electra</th>
      <td>7827</td>
      <td>15</td>
      <td>20</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.iloc[2:5, 1:3]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mpg</th>
      <th>trunk</th>
    </tr>
    <tr>
      <th>make</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AMC Spirit</th>
      <td>22</td>
      <td>12</td>
    </tr>
    <tr>
      <th>Buick Century</th>
      <td>20</td>
      <td>16</td>
    </tr>
    <tr>
      <th>Buick Electra</th>
      <td>15</td>
      <td>20</td>
    </tr>
  </tbody>
</table>
</div>



## 条件选择

条件选择背后的逻辑：

1. 使用df[`condition`] 来请求Pandas过滤数据框
2. `conditon`是每行的`True`或者`False`值序列（因此`condition`的长度必须和dataframe行的长度相同）
3. 在Pandas中，只需在整个列上编写一个布尔表达式，就可以为每一行生成True或False值
4. Pandas仅会显示行为`True`的值。

举例来说：

`df_auto['price'] < 3800` 会每行依次判断 `df_auto['price']`，之后会返回条件为`True` 或者 `False`:

``
0     False
1     False
2      True
3     False
4     False
5     False
``
将条件放入方括号中 `df_auto[ df_auto['price'] < 3800 ]`， Pandas首先会生成值为 `True` / `False`的序列，之后仅显示为`True`的行所对应的值。


```python
df_auto[ df_auto['price'] < 3800 ]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>AMC Spirit</td>
      <td>3799</td>
      <td>22</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>12</td>
      <td>2640</td>
      <td>168</td>
      <td>35</td>
      <td>121</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Chev. Chevette</td>
      <td>3299</td>
      <td>29</td>
      <td>3.0</td>
      <td>2.5</td>
      <td>9</td>
      <td>2110</td>
      <td>163</td>
      <td>34</td>
      <td>231</td>
      <td>2.93</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667</td>
      <td>24</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7</td>
      <td>2750</td>
      <td>179</td>
      <td>40</td>
      <td>151</td>
      <td>2.73</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Merc. Zephyr</td>
      <td>3291</td>
      <td>20</td>
      <td>3.0</td>
      <td>3.5</td>
      <td>17</td>
      <td>2830</td>
      <td>195</td>
      <td>43</td>
      <td>140</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>65</th>
      <td>Subaru</td>
      <td>3798</td>
      <td>35</td>
      <td>5.0</td>
      <td>2.5</td>
      <td>11</td>
      <td>2050</td>
      <td>164</td>
      <td>36</td>
      <td>97</td>
      <td>3.81</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>67</th>
      <td>Toyota Corolla</td>
      <td>3748</td>
      <td>31</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>9</td>
      <td>2200</td>
      <td>165</td>
      <td>35</td>
      <td>97</td>
      <td>3.21</td>
      <td>Foreign</td>
    </tr>
  </tbody>
</table>
</div>



也可以通过链接布尔表达式来组合多个条件： 

* 且: `&`
* 或: `|`


```python
df_auto[(df_auto['price'] < 3800) & (df_auto['foreign'] == 'Foreign')]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>65</th>
      <td>Subaru</td>
      <td>3798</td>
      <td>35</td>
      <td>5.0</td>
      <td>2.5</td>
      <td>11</td>
      <td>2050</td>
      <td>164</td>
      <td>36</td>
      <td>97</td>
      <td>3.81</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>67</th>
      <td>Toyota Corolla</td>
      <td>3748</td>
      <td>31</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>9</td>
      <td>2200</td>
      <td>165</td>
      <td>35</td>
      <td>97</td>
      <td>3.21</td>
      <td>Foreign</td>
    </tr>
  </tbody>
</table>
</div>



注意：如果我们不分配上述所有新dataframe，则上述所有操作均会返回这些新dataframe。如果我们要将其保留为单独的dataframe，则必须像这样分配它：


```python
df_auto_small = df_auto[(df_auto.price < 3800) & (df_auto.foreign == 'Foreign')]
df_auto_small
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>65</th>
      <td>Subaru</td>
      <td>3798</td>
      <td>35</td>
      <td>5.0</td>
      <td>2.5</td>
      <td>11</td>
      <td>2050</td>
      <td>164</td>
      <td>36</td>
      <td>97</td>
      <td>3.81</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>67</th>
      <td>Toyota Corolla</td>
      <td>3748</td>
      <td>31</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>9</td>
      <td>2200</td>
      <td>165</td>
      <td>35</td>
      <td>97</td>
      <td>3.21</td>
      <td>Foreign</td>
    </tr>
  </tbody>
</table>
</div>



## dataframe排序


```python
df_auto.sort_values(by=['headroom', 'trunk'], inplace=True) # df.sort_value()
df_auto.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229</td>
      <td>23</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6</td>
      <td>2370</td>
      <td>170</td>
      <td>35</td>
      <td>119</td>
      <td>3.89</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934</td>
      <td>18</td>
      <td>1.0</td>
      <td>1.5</td>
      <td>7</td>
      <td>3470</td>
      <td>198</td>
      <td>42</td>
      <td>231</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486</td>
      <td>26</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>8</td>
      <td>2520</td>
      <td>182</td>
      <td>38</td>
      <td>119</td>
      <td>3.54</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389</td>
      <td>28</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9</td>
      <td>1800</td>
      <td>147</td>
      <td>33</td>
      <td>98</td>
      <td>3.15</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667</td>
      <td>24</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7</td>
      <td>2750</td>
      <td>179</td>
      <td>40</td>
      <td>151</td>
      <td>2.73</td>
      <td>Domestic</td>
    </tr>
  </tbody>
</table>
</div>



# 处理数据类型

## 当前数据类型


```python
df_auto.dtypes
```




    make             object
    price             int64
    mpg               int64
    rep78           float64
    headroom        float64
    trunk             int64
    weight            int64
    length            int64
    turn              int64
    displacement      int64
    gear_ratio      float64
    foreign          object
    dtype: object



## 转换数据类型

我们可以通过两种方式转换列的数据类型：

1. 循环遍历值并分别转换；
2. 使用内置的Pandas函数一次性转换列。

### 分别转换值


```python
df_auto['length'].apply(lambda x: str(x)).dtypes # apply() + lambda function
```




    dtype('O')



注意: `'O'` 表示 'object'


```python
df_auto['length'].apply(lambda x: int(x)).dtypes
```




    dtype('int64')



### 直接转换列

如果想将列转化为`string`，建议使用`.astype(str)`:


```python
df_auto['length'].astype(str).dtypes
```




    dtype('O')



如果想将列转化为`numeric`，建议使用`df.to_numeric()`:


```python
pd.to_numeric(df_auto['length']).dtypes
```




    dtype('int64')



# 处理缺失值

http://pandas.pydata.org/pandas-docs/stable/missing_data.html

## 添加缺失值

将缺失值定义为`np.nan`：


```python
df_auto.loc['UvT_Car'] = [np.nan for x in range(0,len(df_auto.columns))]
df_auto.loc['UvT_Bike'] = [np.nan for x in range(0,len(df_auto.columns))]
```


```python
df_auto.loc[['UvT_Car', 'UvT_Bike']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>UvT_Car</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>UvT_Bike</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



## 选择缺失或非缺失值

始终使用`pd.isnull()` 或`pd.notnull()` 最为可靠,`df_auto.make == np.nan` 有时无法取得正确的结果。


```python
df_auto[pd.isnull(df_auto.make)]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>UvT_Car</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>UvT_Bike</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_auto[pd.notnull(df_auto.make)].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
      <td>35.0</td>
      <td>119.0</td>
      <td>3.89</td>
      <td>Foreign</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
      <td>42.0</td>
      <td>231.0</td>
      <td>3.08</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>8.0</td>
      <td>2520.0</td>
      <td>182.0</td>
      <td>38.0</td>
      <td>119.0</td>
      <td>3.54</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>28.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9.0</td>
      <td>1800.0</td>
      <td>147.0</td>
      <td>33.0</td>
      <td>98.0</td>
      <td>3.15</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>40.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
    </tr>
  </tbody>
</table>
</div>



## 填补缺失值

使用`fillna()`填补缺失值：


```python
df = df_auto.fillna('Missing')
df.loc[['UvT_Car', 'UvT_Bike']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>UvT_Car</th>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
    </tr>
    <tr>
      <th>UvT_Bike</th>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
      <td>Missing</td>
    </tr>
  </tbody>
</table>
</div>



## 删除含缺失值的行

使用`.dropna()`删除缺失值：


```python
df_auto['make'].tail(3)
```




    45          Plym. Volare
    UvT_Car              NaN
    UvT_Bike             NaN
    Name: make, dtype: object




```python
df = df_auto.dropna(axis=0)
df['make'].tail(3)
```




    36       Olds Cutlass
    22    Dodge St. Regis
    45       Plym. Volare
    Name: make, dtype: object



# 处理 dataframe

## 合并列（Combine columns）生成新的一列


```python
df_auto['price_trunk_ratio'] = df_auto.price / df_auto.trunk
df_auto[['price', 'trunk', 'price_trunk_ratio']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>trunk</th>
      <th>price_trunk_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>6229.0</td>
      <td>6.0</td>
      <td>1038.166667</td>
    </tr>
    <tr>
      <th>47</th>
      <td>4934.0</td>
      <td>7.0</td>
      <td>704.857143</td>
    </tr>
    <tr>
      <th>44</th>
      <td>6486.0</td>
      <td>8.0</td>
      <td>810.750000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>4389.0</td>
      <td>9.0</td>
      <td>487.666667</td>
    </tr>
    <tr>
      <th>17</th>
      <td>3667.0</td>
      <td>7.0</td>
      <td>523.857143</td>
    </tr>
  </tbody>
</table>
</div>



## 通过遍历（iterate）每行数据框来生成新列

**提出问题：如果是国外车(Foreign)，将价格（Price）乘以1.5。**

### 法一：使用`apply()`函数和`lambda`


```python
logic = lambda x: x.price*1.5 if x.foreign == 'Foreign' else x.price
df_auto['new_price'] = df_auto.apply(logic, axis=1)
df_auto[['make', 'price', 'foreign', 'new_price']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>foreign</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>Foreign</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>Domestic</td>
      <td>4934.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>Domestic</td>
      <td>6486.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>Domestic</td>
      <td>4389.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>Domestic</td>
      <td>3667.0</td>
    </tr>
  </tbody>
</table>
</div>



### 法二：使用`apply()`和函数

在上面的示例中，我们使用匿名lambda函数。  
对于更复杂的处理，可以使用已定义的函数并在`.apply()`中调用它。  
比较建议这种方式，因为最灵活并且更易于阅读。


```python
def new_price_function(x):
    if x.foreign == 'Foreign':
        return x.price * 1.5
    else:
        return x.price
```


```python
df_auto['new_price'] = df_auto.apply(new_price_function, axis=1) # axis =1: iterate over rows
df_auto[['make', 'price', 'foreign', 'new_price']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>foreign</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>Foreign</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>Domestic</td>
      <td>4934.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>Domestic</td>
      <td>6486.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>Domestic</td>
      <td>4389.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>Domestic</td>
      <td>3667.0</td>
    </tr>
  </tbody>
</table>
</div>



### 法三：列表推导式


```python
df_auto['new_price'] = [p*1.5 if f == 'Foreign' else p for p, f in zip(df_auto.price, df_auto.foreign)]
df_auto[['price', 'foreign', 'new_price']].sample(5, random_state=1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>foreign</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>58</th>
      <td>8129.0</td>
      <td>Foreign</td>
      <td>12193.5</td>
    </tr>
    <tr>
      <th>49</th>
      <td>4723.0</td>
      <td>Domestic</td>
      <td>4723.0</td>
    </tr>
    <tr>
      <th>41</th>
      <td>4647.0</td>
      <td>Domestic</td>
      <td>4647.0</td>
    </tr>
    <tr>
      <th>36</th>
      <td>4733.0</td>
      <td>Domestic</td>
      <td>4733.0</td>
    </tr>
    <tr>
      <th>40</th>
      <td>10371.0</td>
      <td>Domestic</td>
      <td>10371.0</td>
    </tr>
  </tbody>
</table>
</div>



注意：`random_state=1`保证每次获取同样的随机数样本。

## 合并dataframe

有三种方式合并dataframe：

1. Merge  
2. Join  
3. Append  


```python
# 数据准备
df_auto_p1 = df_auto[['make', 'price', 'mpg']]
df_auto_p2 = df_auto[['make', 'headroom', 'trunk']]
```


```python
df_auto_p1.head(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_auto_p2.head(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>headroom</th>
      <th>trunk</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>1.5</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>1.5</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>1.5</td>
      <td>8.0</td>
    </tr>
  </tbody>
</table>
</div>



### Merge 数据集

http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.merge.html 


```python
merged_auto = pd.merge(df_auto_p1, df_auto_p2, how='left', on='make')
merged_auto.head(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>1.5</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.5</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
      <td>1.5</td>
      <td>8.0</td>
    </tr>
  </tbody>
</table>
</div>



### 在索引上Join数据集

两个dataframe都必须具有与索引相同的列集（column set）


```python
df_auto_p1.set_index('make', inplace=True)
df_auto_p2.set_index('make', inplace=True)
```

### Append

http://pandas.pydata.org/pandas-docs/stable/merging.html#concatenating-objects


```python
df_auto_i1 = df_auto.iloc[0:3]
df_auto_i2 = df_auto.iloc[3:6]
```


```python
df_auto_i1
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
      <th>price_trunk_ratio</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
      <td>35.0</td>
      <td>119.0</td>
      <td>3.89</td>
      <td>Foreign</td>
      <td>1038.166667</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
      <td>42.0</td>
      <td>231.0</td>
      <td>3.08</td>
      <td>Domestic</td>
      <td>704.857143</td>
      <td>4934.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>8.0</td>
      <td>2520.0</td>
      <td>182.0</td>
      <td>38.0</td>
      <td>119.0</td>
      <td>3.54</td>
      <td>Domestic</td>
      <td>810.750000</td>
      <td>6486.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_auto_i2
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
      <th>price_trunk_ratio</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>28.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9.0</td>
      <td>1800.0</td>
      <td>147.0</td>
      <td>33.0</td>
      <td>98.0</td>
      <td>3.15</td>
      <td>Domestic</td>
      <td>487.666667</td>
      <td>4389.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>40.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>523.857143</td>
      <td>3667.0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>Pont. Sunbird</td>
      <td>4172.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2690.0</td>
      <td>179.0</td>
      <td>41.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>596.000000</td>
      <td>4172.0</td>
    </tr>
  </tbody>
</table>
</div>



使用`concat()`函数:


```python
pd.concat([df_auto_i1, df_auto_i2])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
      <th>price_trunk_ratio</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
      <td>35.0</td>
      <td>119.0</td>
      <td>3.89</td>
      <td>Foreign</td>
      <td>1038.166667</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
      <td>42.0</td>
      <td>231.0</td>
      <td>3.08</td>
      <td>Domestic</td>
      <td>704.857143</td>
      <td>4934.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>8.0</td>
      <td>2520.0</td>
      <td>182.0</td>
      <td>38.0</td>
      <td>119.0</td>
      <td>3.54</td>
      <td>Domestic</td>
      <td>810.750000</td>
      <td>6486.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>28.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9.0</td>
      <td>1800.0</td>
      <td>147.0</td>
      <td>33.0</td>
      <td>98.0</td>
      <td>3.15</td>
      <td>Domestic</td>
      <td>487.666667</td>
      <td>4389.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>40.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>523.857143</td>
      <td>3667.0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>Pont. Sunbird</td>
      <td>4172.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2690.0</td>
      <td>179.0</td>
      <td>41.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>596.000000</td>
      <td>4172.0</td>
    </tr>
  </tbody>
</table>
</div>



使用`append()`函数:


```python
df_auto_i1.append(df_auto_i2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
      <th>price_trunk_ratio</th>
      <th>new_price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
      <td>35.0</td>
      <td>119.0</td>
      <td>3.89</td>
      <td>Foreign</td>
      <td>1038.166667</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
      <td>42.0</td>
      <td>231.0</td>
      <td>3.08</td>
      <td>Domestic</td>
      <td>704.857143</td>
      <td>4934.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>8.0</td>
      <td>2520.0</td>
      <td>182.0</td>
      <td>38.0</td>
      <td>119.0</td>
      <td>3.54</td>
      <td>Domestic</td>
      <td>810.750000</td>
      <td>6486.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>28.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>9.0</td>
      <td>1800.0</td>
      <td>147.0</td>
      <td>33.0</td>
      <td>98.0</td>
      <td>3.15</td>
      <td>Domestic</td>
      <td>487.666667</td>
      <td>4389.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>40.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>523.857143</td>
      <td>3667.0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>Pont. Sunbird</td>
      <td>4172.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2690.0</td>
      <td>179.0</td>
      <td>41.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>596.000000</td>
      <td>4172.0</td>
    </tr>
  </tbody>
</table>
</div>



## 分组操作（Group-by operations）

使用`.groupby()`实现组内操作，处理流程如下：

1. **Split**: 根据某些条件将数据分为几组
2. **Apply**: 分别对每个组应用函数
3. **Combine**: 将结果组合到数据结构中

参阅:http://pandas.pydata.org/pandas-docs/stable/groupby.html

### 通过创建group对象拆分dataframe

步骤1：创建一个组对象，该对象指定我们要创建的组。


```python
col_list = ['price', 'mpg', 'headroom', 'trunk', 'weight', 'length']
grouped = df_auto[col_list + ['foreign']].groupby(['foreign'])
```

### 应用示例1：计算均值摘要统计量


```python
grouped.mean()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>6072.423077</td>
      <td>19.826923</td>
      <td>3.153846</td>
      <td>14.750000</td>
      <td>3317.115385</td>
      <td>196.134615</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>6384.681818</td>
      <td>24.772727</td>
      <td>2.613636</td>
      <td>11.409091</td>
      <td>2315.909091</td>
      <td>168.545455</td>
    </tr>
  </tbody>
</table>
</div>



### 应用示例2：检索特定组


```python
grouped.get_group('Domestic').head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>foreign</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>47</th>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>44</th>
      <td>6486.0</td>
      <td>26.0</td>
      <td>1.5</td>
      <td>8.0</td>
      <td>2520.0</td>
      <td>182.0</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>23</th>
      <td>4389.0</td>
      <td>28.0</td>
      <td>1.5</td>
      <td>9.0</td>
      <td>1800.0</td>
      <td>147.0</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>17</th>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>Domestic</td>
    </tr>
    <tr>
      <th>51</th>
      <td>4172.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2690.0</td>
      <td>179.0</td>
      <td>Domestic</td>
    </tr>
  </tbody>
</table>
</div>



### 应用示例3：遍历`group`对象中的组


```python
for name, group in grouped:
    print(name)
    print(group.head())
```

    Domestic
         price   mpg  headroom  trunk  weight  length   foreign
    47  4934.0  18.0       1.5    7.0  3470.0   198.0  Domestic
    44  6486.0  26.0       1.5    8.0  2520.0   182.0  Domestic
    23  4389.0  28.0       1.5    9.0  1800.0   147.0  Domestic
    17  3667.0  24.0       2.0    7.0  2750.0   179.0  Domestic
    51  4172.0  24.0       2.0    7.0  2690.0   179.0  Domestic
    Foreign
         price   mpg  headroom  trunk  weight  length  foreign
    55  6229.0  23.0       1.5    6.0  2370.0   170.0  Foreign
    56  4589.0  35.0       2.0    8.0  2020.0   165.0  Foreign
    68  5719.0  18.0       2.0   11.0  2670.0   175.0  Foreign
    72  6850.0  25.0       2.0   16.0  1990.0   156.0  Foreign
    61  4499.0  28.0       2.5    5.0  1760.0   149.0  Foreign


在`group`对象中应用`.apply()`函数：

在`.apply（）`中使用`lambda`是迭代数据子集的好方法。   
例如，假设我们要获得每个`trunk`尺寸类别中最便宜的汽车：


```python
df_auto.groupby('trunk').apply(lambda df: df.sort_values('price').iloc[0]).head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>mpg</th>
      <th>rep78</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
      <th>turn</th>
      <th>displacement</th>
      <th>gear_ratio</th>
      <th>foreign</th>
      <th>price_trunk_ratio</th>
      <th>new_price</th>
    </tr>
    <tr>
      <th>trunk</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5.0</th>
      <td>Honda Civic</td>
      <td>4499.0</td>
      <td>28.0</td>
      <td>4.0</td>
      <td>2.5</td>
      <td>5.0</td>
      <td>1760.0</td>
      <td>149.0</td>
      <td>34.0</td>
      <td>91.0</td>
      <td>3.30</td>
      <td>Foreign</td>
      <td>899.800000</td>
      <td>6748.5</td>
    </tr>
    <tr>
      <th>6.0</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>23.0</td>
      <td>4.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
      <td>35.0</td>
      <td>119.0</td>
      <td>3.89</td>
      <td>Foreign</td>
      <td>1038.166667</td>
      <td>9343.5</td>
    </tr>
    <tr>
      <th>7.0</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>2750.0</td>
      <td>179.0</td>
      <td>40.0</td>
      <td>151.0</td>
      <td>2.73</td>
      <td>Domestic</td>
      <td>523.857143</td>
      <td>3667.0</td>
    </tr>
    <tr>
      <th>8.0</th>
      <td>Dodge Colt</td>
      <td>3984.0</td>
      <td>30.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>2120.0</td>
      <td>163.0</td>
      <td>35.0</td>
      <td>98.0</td>
      <td>3.54</td>
      <td>Domestic</td>
      <td>498.000000</td>
      <td>3984.0</td>
    </tr>
    <tr>
      <th>9.0</th>
      <td>Chev. Chevette</td>
      <td>3299.0</td>
      <td>29.0</td>
      <td>3.0</td>
      <td>2.5</td>
      <td>9.0</td>
      <td>2110.0</td>
      <td>163.0</td>
      <td>34.0</td>
      <td>231.0</td>
      <td>2.93</td>
      <td>Domestic</td>
      <td>366.555556</td>
      <td>3299.0</td>
    </tr>
  </tbody>
</table>
</div>



## 将groupby对象聚合到新 dataframe

如果要将每个组汇总到新数据框中的一行，则可以使用以下两个示例中的许多选项：

### `grouped.sum()` 和 `gropued.mean()`


```python
grouped.sum()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>315766.0</td>
      <td>1031.0</td>
      <td>164.0</td>
      <td>767.0</td>
      <td>172490.0</td>
      <td>10199.0</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>140463.0</td>
      <td>545.0</td>
      <td>57.5</td>
      <td>251.0</td>
      <td>50950.0</td>
      <td>3708.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
grouped.mean()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>6072.423077</td>
      <td>19.826923</td>
      <td>3.153846</td>
      <td>14.750000</td>
      <td>3317.115385</td>
      <td>196.134615</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>6384.681818</td>
      <td>24.772727</td>
      <td>2.613636</td>
      <td>11.409091</td>
      <td>2315.909091</td>
      <td>168.545455</td>
    </tr>
  </tbody>
</table>
</div>



### `grouped.count()` 和 `gropued.size()`


```python
grouped.count()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>52</td>
      <td>52</td>
      <td>52</td>
      <td>52</td>
      <td>52</td>
      <td>52</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>22</td>
      <td>22</td>
      <td>22</td>
      <td>22</td>
      <td>22</td>
      <td>22</td>
    </tr>
  </tbody>
</table>
</div>




```python
grouped.size()
```




    foreign
    Domestic    52
    Foreign     22
    dtype: int64



### `grouped.first()` 和 `gropued.last()`


```python
grouped.first()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>4934.0</td>
      <td>18.0</td>
      <td>1.5</td>
      <td>7.0</td>
      <td>3470.0</td>
      <td>198.0</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>6229.0</td>
      <td>23.0</td>
      <td>1.5</td>
      <td>6.0</td>
      <td>2370.0</td>
      <td>170.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
grouped.last()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>mpg</th>
      <th>headroom</th>
      <th>trunk</th>
      <th>weight</th>
      <th>length</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>4060.0</td>
      <td>18.0</td>
      <td>5.0</td>
      <td>16.0</td>
      <td>3330.0</td>
      <td>201.0</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>12990.0</td>
      <td>14.0</td>
      <td>3.5</td>
      <td>14.0</td>
      <td>3420.0</td>
      <td>192.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
grouped.agg({'price' : 'first', 'mpg' : ['mean', 'median'], 'trunk' : ['mean', (lambda x: 100 * np.mean(x))]})
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>price</th>
      <th colspan="2" halign="left">mpg</th>
      <th colspan="2" halign="left">trunk</th>
    </tr>
    <tr>
      <th></th>
      <th>first</th>
      <th>mean</th>
      <th>median</th>
      <th>mean</th>
      <th>&lt;lambda_0&gt;</th>
    </tr>
    <tr>
      <th>foreign</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Domestic</th>
      <td>4934.0</td>
      <td>19.826923</td>
      <td>19.0</td>
      <td>14.750000</td>
      <td>1475.000000</td>
    </tr>
    <tr>
      <th>Foreign</th>
      <td>6229.0</td>
      <td>24.772727</td>
      <td>24.5</td>
      <td>11.409091</td>
      <td>1140.909091</td>
    </tr>
  </tbody>
</table>
</div>



`.groupby`更多的操作可以参阅：  
https://pandas.pydata.org/pandas-docs/stable/groupby.html

# 重塑和数据透视表

## 创建演示数据


```python
tuples = [('bar', 'one',   1, 2),
          ('bar', 'two',   3, 4),
          ('bar', 'three', 5, 6),
          ('baz', 'one',   1, 2),
          ('baz', 'two',   3, 4),
          ('baz', 'three', 5, 6),
          ('foo', 'one',   1, 2),
          ('foo', 'two',   3, 4),
          ('foo', 'three', 5, 6)
         ]
df = pd.DataFrame(tuples)
df.columns = ['first', 'second', 'A', 'B']
```


```python
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first</th>
      <th>second</th>
      <th>A</th>
      <th>B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bar</td>
      <td>one</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>bar</td>
      <td>two</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bar</td>
      <td>three</td>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>baz</td>
      <td>one</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>baz</td>
      <td>two</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>baz</td>
      <td>three</td>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>6</th>
      <td>foo</td>
      <td>one</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>foo</td>
      <td>two</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>8</th>
      <td>foo</td>
      <td>three</td>
      <td>5</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>



## 示例1：创建透视表（Create a pivot table）

使用`pivot()`函数：  
http://pandas.pydata.org/pandas-docs/stable/reshaping.html#reshaping-by-pivoting-dataframe-objects


```python
df.pivot(index='first', columns='second', values='A')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>second</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
    </tr>
    <tr>
      <th>first</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bar</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>baz</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>foo</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>



使用 `pd.pivot_table()` 函数:
http://pandas.pydata.org/pandas-docs/stable/generated/pandas.pivot_table.html


```python
pd.pivot_table(df, values=['A', 'B'], index='first', columns='second')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">A</th>
      <th colspan="3" halign="left">B</th>
    </tr>
    <tr>
      <th>second</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
    </tr>
    <tr>
      <th>first</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bar</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>baz</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>foo</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>



说明1：以上内容说明了Pandas本质上具有两个索引：通常的“row index”和“column index”。  
说明2：Pandas 还具有一个称为`pandas.melt`（https://pandas.pydata.org/pandas-docs/stable/generated/pandas.melt.html)

## 示例2：堆叠与去堆叠（Stack and Unstack）

`Stack`和`Unstack`是高级操作符，用于基于多级索引来重塑数据框。

- Stack --> 向下移动数据
- Unstack --> 向上移动数据

## Stack


```python
pivot_df = pd.pivot_table(df, values=['A', 'B'], index='first', columns='second')
pivot_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">A</th>
      <th colspan="3" halign="left">B</th>
    </tr>
    <tr>
      <th>second</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
    </tr>
    <tr>
      <th>first</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bar</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>baz</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>foo</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>




```python
pivot_df.stack(level=['second'])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">bar</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">baz</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">foo</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>



注意：我们也可以只使用`pivot_df.stack()`，因为它将默认选择索引的“last”级别。

## Unstack


```python
df.set_index(['first', 'second'], inplace=True)
```


```python
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">bar</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">baz</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">foo</th>
      <th>one</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.unstack(level=['first'])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">A</th>
      <th colspan="3" halign="left">B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>bar</th>
      <th>baz</th>
      <th>foo</th>
      <th>bar</th>
      <th>baz</th>
      <th>foo</th>
    </tr>
    <tr>
      <th>second</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>one</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>three</th>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
    </tr>
    <tr>
      <th>two</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>4</td>
      <td>4</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.unstack(level=['second'])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">A</th>
      <th colspan="3" halign="left">B</th>
    </tr>
    <tr>
      <th>second</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
      <th>one</th>
      <th>three</th>
      <th>two</th>
    </tr>
    <tr>
      <th>first</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>bar</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>baz</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>foo</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>2</td>
      <td>6</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>



# 处理日期数据

Pandas具有很多内置功能来处理时间序列数据   
http://pandas.pydata.org/pandas-docs/stable/timeseries.html

文档概览：

| Class           | Remarks                        | How to create:                               |
|-----------------|--------------------------------|----------------------------------------------|
| `Timestamp`     | Represents a single time stamp | `to_datetime`, `Timestamp`                   |
| `DatetimeIndex` | Index of `Timestamp`           | `to_datetime`, `date_range`, `DatetimeIndex` |
| `Period`        | Represents a single time span  | `Period`                                     |
| `PeriodIndex`   | Index of `Period`              | `period_range`, `PeriodIndex`                |

## 生成日期范围


```python
date_index = pd.date_range('1/1/2011', periods=len(df_auto.index), freq='D')
date_index[0:5]
```




    DatetimeIndex(['2011-01-01', '2011-01-02', '2011-01-03', '2011-01-04',
                   '2011-01-05'],
                  dtype='datetime64[ns]', freq='D')



便于解释，在`df_auto`中添加日期：


```python
df_ad = df_auto.copy()[['make', 'price']]
df_ad['date'] = date_index
```


```python
df_ad.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>2011-01-01</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>2011-01-02</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>2011-01-03</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>2011-01-04</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>2011-01-05</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_ad.dtypes
```




    make             object
    price           float64
    date     datetime64[ns]
    dtype: object



## 将 `str` 列转为 `date` 列

从外部导入数据的时候，会将日期数据识别成字符型。


```python
df_ad['date'] = df_ad['date'].astype(str)
df_ad['date'].dtypes
```




    dtype('O')



我们现在无法对该列执行任何日期时间操作，因为它的数据类型错误！

幸运的是，我们可以这样修复它：


```python
pd.to_datetime(df_ad['date']).dtypes
```




    dtype('<M8[ns]')



或者：


```python
df_ad['date'] = df_ad['date'].apply(lambda x: pd.to_datetime(x))
```

## 选择特定范围内的观察值


```python
pd.Timestamp('2011-02-01')
```




    Timestamp('2011-02-01 00:00:00')




```python
pd.to_datetime('01-02-2011', format='%d-%m-%Y')
```




    Timestamp('2011-02-01 00:00:00')



提示：通常最好明确包含格式，以避免意外行为。


```python
df_ad[df_ad.date > pd.to_datetime('07-03-2011', format='%d-%m-%Y')]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>37</th>
      <td>Olds Delta 88</td>
      <td>4890.0</td>
      <td>2011-03-08</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Pont. Catalina</td>
      <td>5798.0</td>
      <td>2011-03-09</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Buick LeSabre</td>
      <td>5788.0</td>
      <td>2011-03-10</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Olds Omega</td>
      <td>4181.0</td>
      <td>2011-03-11</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Buick Century</td>
      <td>4816.0</td>
      <td>2011-03-12</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Olds Cutlass</td>
      <td>4733.0</td>
      <td>2011-03-13</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Dodge St. Regis</td>
      <td>6342.0</td>
      <td>2011-03-14</td>
    </tr>
    <tr>
      <th>45</th>
      <td>Plym. Volare</td>
      <td>4060.0</td>
      <td>2011-03-15</td>
    </tr>
    <tr>
      <th>UvT_Car</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>2011-03-16</td>
    </tr>
    <tr>
      <th>UvT_Bike</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>2011-03-17</td>
    </tr>
  </tbody>
</table>
</div>



我们也可以使用Pandas的`.isin()`代替`date_range`对象。


```python
df_ad[df_ad.date.isin(pd.date_range('2/20/2011', '3/11/2011', freq='D'))]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11</th>
      <td>Cad. Eldorado</td>
      <td>14500.0</td>
      <td>2011-02-20</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Merc. Cougar</td>
      <td>5379.0</td>
      <td>2011-02-21</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Buick Riviera</td>
      <td>10372.0</td>
      <td>2011-02-22</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Chev. Malibu</td>
      <td>4504.0</td>
      <td>2011-02-23</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Merc. Zephyr</td>
      <td>3291.0</td>
      <td>2011-02-24</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Olds Toronado</td>
      <td>10371.0</td>
      <td>2011-02-25</td>
    </tr>
    <tr>
      <th>49</th>
      <td>Pont. Le Mans</td>
      <td>4723.0</td>
      <td>2011-02-26</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Linc. Continental</td>
      <td>11497.0</td>
      <td>2011-02-27</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Merc. Marquis</td>
      <td>6165.0</td>
      <td>2011-02-28</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Dodge Diplomat</td>
      <td>4010.0</td>
      <td>2011-03-01</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Dodge Magnum</td>
      <td>5886.0</td>
      <td>2011-03-02</td>
    </tr>
    <tr>
      <th>43</th>
      <td>Plym. Horizon</td>
      <td>4482.0</td>
      <td>2011-03-03</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Buick Electra</td>
      <td>7827.0</td>
      <td>2011-03-04</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Cad. Deville</td>
      <td>11385.0</td>
      <td>2011-03-05</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Chev. Impala</td>
      <td>5705.0</td>
      <td>2011-03-06</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Olds 98</td>
      <td>8814.0</td>
      <td>2011-03-07</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Olds Delta 88</td>
      <td>4890.0</td>
      <td>2011-03-08</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Pont. Catalina</td>
      <td>5798.0</td>
      <td>2011-03-09</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Buick LeSabre</td>
      <td>5788.0</td>
      <td>2011-03-10</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Olds Omega</td>
      <td>4181.0</td>
      <td>2011-03-11</td>
    </tr>
  </tbody>
</table>
</div>



## 提取日期的组成部分

可以从日期中提取`day`,`month`和`year`：  

http://pandas.pydata.org/pandas-docs/stable/timeseries.html#time-date-components


```python
df_ad['day'] = df_ad['date'].apply(lambda x: x.day)
df_ad.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>date</th>
      <th>day</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>2011-01-01</td>
      <td>1</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>2011-01-02</td>
      <td>2</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>2011-01-03</td>
      <td>3</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>2011-01-04</td>
      <td>4</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>2011-01-05</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>



## 日期运算（Manipulate）

参阅： http://pandas.pydata.org/pandas-docs/stable/timeseries.html#dateoffset-objects  


```python
df_ad['new_date'] = df_ad.date.apply(lambda x: x + pd.DateOffset(years=1))
df_ad.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>make</th>
      <th>price</th>
      <th>date</th>
      <th>day</th>
      <th>new_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>Datsun 200</td>
      <td>6229.0</td>
      <td>2011-01-01</td>
      <td>1</td>
      <td>2012-01-01</td>
    </tr>
    <tr>
      <th>47</th>
      <td>Pont. Firebird</td>
      <td>4934.0</td>
      <td>2011-01-02</td>
      <td>2</td>
      <td>2012-01-02</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Plym. Sapporo</td>
      <td>6486.0</td>
      <td>2011-01-03</td>
      <td>3</td>
      <td>2012-01-03</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ford Fiesta</td>
      <td>4389.0</td>
      <td>2011-01-04</td>
      <td>4</td>
      <td>2012-01-04</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Chev. Monza</td>
      <td>3667.0</td>
      <td>2011-01-05</td>
      <td>5</td>
      <td>2012-01-05</td>
    </tr>
  </tbody>
</table>
</div>


